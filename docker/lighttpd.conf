# Lighttpd configuration for JellyStream Docker

server.modules = (
    "mod_access",
    "mod_fastcgi",
    "mod_accesslog",
    "mod_proxy"
)

server.document-root = "/var/www/html"
server.upload-dirs = ( "/tmp" )
server.errorlog = "/dev/stderr"
server.pid-file = "/var/run/lighttpd.pid"
server.username = "lighttpd"
server.groupname = "lighttpd"
server.port = 8080

# Index files
index-file.names = ( "index.php", "index.html" )

# MIME types
mimetype.assign = (
    ".html" => "text/html",
    ".htm" => "text/html",
    ".txt" => "text/plain",
    ".jpg" => "image/jpeg",
    ".jpeg" => "image/jpeg",
    ".png" => "image/png",
    ".gif" => "image/gif",
    ".css" => "text/css",
    ".js" => "application/javascript",
    ".json" => "application/json",
    ".xml" => "text/xml",
    ".svg" => "image/svg+xml",
    ".ico" => "image/x-icon"
)

# Access log
accesslog.filename = "/dev/stdout"

# FastCGI configuration for PHP
fastcgi.server = ( ".php" =>
    ((
        "bin-path" => "/usr/bin/php-cgi81",
        "socket" => "/tmp/php.socket",
        "max-procs" => 2,
        "bin-environment" => (
            "PHP_FCGI_CHILDREN" => "4",
            "PHP_FCGI_MAX_REQUESTS" => "1000"
        ),
        "broken-scriptfilename" => "enable"
    ))
)

# Proxy API requests to backend container
$HTTP["url"] =~ "^/api/" {
    proxy.server = ( "" => (
        ( "host" => "api", "port" => 8000 )
    ))
    proxy.header = (
        "https-remap" => "disable"
    )
}

# Security headers
server.http-headers = (
    "X-Frame-Options" => "SAMEORIGIN",
    "X-Content-Type-Options" => "nosniff",
    "X-XSS-Protection" => "1; mode=block"
)

# Deny access to hidden files
$HTTP["url"] =~ "^/\." {
    url.access-deny = ( "" )
}

# Deny access to .env files
$HTTP["url"] =~ "\.env" {
    url.access-deny = ( "" )
}
